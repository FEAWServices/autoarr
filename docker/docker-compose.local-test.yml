# =============================================================================
# AutoArr Local Test Environment
# =============================================================================
# Runs AutoArr for local testing using the SAME base image as devcontainer.
# Both containers share the same Windows mount for consistent node_modules.
#
# Access Points:
#   - http://localhost:9080  - Full application (Vite dev server + API proxy)
#   - http://localhost:9081  - Direct API access (optional)
#   - http://localhost:6006  - Storybook (component library)
#
# Hot Reloading:
#   - Backend: Python code changes detected automatically
#   - Frontend: Vite HMR - instant updates on save
#   - Storybook: Hot reload on component/story changes
#
# Usage:
#   # Build the shared dev image first (from repo root):
#   docker build -t autoarr:dev -f .devcontainer/Dockerfile .
#
#   # Then run:
#   docker-compose -f docker/docker-compose.local-test.yml up -d
#   docker-compose -f docker/docker-compose.local-test.yml logs -f
#   docker-compose -f docker/docker-compose.local-test.yml down
#
# Architecture:
#   DevContainer and Local Test Container share:
#   - Same base image (autoarr:dev from .devcontainer/Dockerfile)
#   - Same Windows mount (c:/Git/autoarr -> /app)
#   - Same node_modules (no duplication)
#   - Same Python .venv
# =============================================================================

name: autoarr_app

services:
  autoarr:
    image: autoarr:dev
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    container_name: autoarr-local
    restart: unless-stopped

    ports:
      - "9080:5173" # Vite dev server (frontend + API proxy)
      - "9081:8088" # Direct backend access (optional)

    environment:
      APP_ENV: development
      LOG_LEVEL: DEBUG
      PORT: 8088
      PYTHONPATH: /app
      DATABASE_URL: sqlite:////data/autoarr.db
      REDIS_URL: memory://
      VITE_DEV_MODE: "true"
      # HMR client port - tells Vite to use the mapped port for WebSocket
      VITE_HMR_CLIENT_PORT: "9080"
      # Use Vite proxy for API calls (empty = relative URLs)
      VITE_API_BASE_URL: ""
      # pnpm configuration
      PNPM_HOME: "/root/.local/share/pnpm"

    # Memory limits
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "1.5"
        reservations:
          memory: 512M

    volumes:
      # Mount source code from Windows - SAME path as devcontainer
      - c:/Git/autoarr:/app:cached
      # Shared pnpm store (same volume as devcontainer)
      - autoarr-pnpm-store:/root/.local/share/pnpm/store
      # Playwright browser cache - persists between restarts
      - autoarr-playwright-cache:/root/.cache/ms-playwright
      # Persistent data
      - autoarr-data:/data
      - autoarr-logs:/app/logs

    # Fast startup - only install if needed, skip playwright if cached
    command: >
      sh -c "
        echo '========================================' &&
        echo 'AutoArr Local Test Container Starting...' &&
        echo '========================================' &&

        cd /app &&

        # Only run poetry install if .venv is missing or outdated
        if [ ! -d .venv ] || [ poetry.lock -nt .venv ]; then
          echo 'Installing Python dependencies...' &&
          poetry install --no-interaction --only main
        else
          echo 'Python deps up to date, skipping...'
        fi &&

        cd /app/autoarr/ui &&

        # Only run pnpm install if node_modules is missing
        if [ ! -d node_modules ]; then
          echo 'Installing Node dependencies...' &&
          pnpm install --prefer-offline
        else
          echo 'Node deps exist, skipping install...'
        fi &&

        # Only install Playwright if not cached
        if [ ! -d /root/.cache/ms-playwright/chromium-* ]; then
          echo 'Installing Playwright browser (first run only)...' &&
          pnpm exec playwright install chromium
        else
          echo 'Playwright browser cached, skipping...'
        fi &&

        echo '' &&
        echo '========================================' &&
        echo 'Starting API server on port 8088...' &&
        echo '========================================' &&
        (cd /app && poetry run uvicorn autoarr.api.main:app --host 0.0.0.0 --port 8088 &) &&
        sleep 2 &&
        echo '' &&
        echo '========================================' &&
        echo 'Starting Vite dev server on port 5173...' &&
        echo '========================================' &&
        echo '' &&
        echo '**************************************' &&
        echo '* AutoArr will be ready at:         *' &&
        echo '*   http://localhost:9080           *' &&
        echo '**************************************' &&
        echo '' &&
        pnpm run dev --host 0.0.0.0 --port 5173
      "

    healthcheck:
      # Check both frontend (Vite) and backend (API readiness with warmup)
      test:
        [
          "CMD-SHELL",
          "curl -sf http://localhost:5173 && curl -sf http://localhost:8088/health/ready",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

    networks:
      - autoarr-net

  # Storybook - Component library and design system
  storybook:
    image: autoarr:dev
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    container_name: autoarr-storybook
    restart: unless-stopped

    ports:
      - "6006:6006" # Storybook default port

    environment:
      NODE_ENV: development
      PNPM_HOME: "/root/.local/share/pnpm"

    # Minimum memory limits
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "0.5"
        reservations:
          memory: 256M

    volumes:
      # Mount source code from Windows - SAME path as devcontainer
      - c:/Git/autoarr:/app:cached
      # Shared pnpm store
      - autoarr-pnpm-store:/root/.local/share/pnpm/store

    command: >
      sh -c "
        cd /app/autoarr/ui &&
        pnpm install --prefer-offline &&
        pnpm storybook --host 0.0.0.0 --port 6006 --no-open
      "

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6006"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

    networks:
      - autoarr-net

networks:
  autoarr-net:
    driver: bridge

volumes:
  autoarr-data:
  autoarr-logs:
  # Shared pnpm store - same name as in devcontainer.json
  autoarr-pnpm-store:
    external: true
  # Playwright browser cache - persists between restarts
  autoarr-playwright-cache:
