# =============================================================================
# AutoArr Production Docker Compose
# =============================================================================
# Self-contained single-container deployment (like Sonarr/Radarr).
# Uses embedded SQLite database - no external database required.
#
# Usage with pre-built image:
#   docker-compose -f docker/docker-compose.production.yml up -d
#
# Usage with local build:
#   docker-compose -f docker/docker-compose.production.yml up -d --build
#
# Data persistence:
#   All data stored in ./data/autoarr.db (SQLite)
#   Logs stored in ./logs/
# =============================================================================
version: "3.8"

services:
  autoarr:
    # Use pre-built image from GitHub Container Registry
    image: ghcr.io/feawservices/autoarr:latest

    # Or build locally (uncomment below, comment out image above)
    # build:
    #   context: ..
    #   dockerfile: docker/Dockerfile.production

    container_name: autoarr
    restart: unless-stopped

    ports:
      - "8088:8088"

    volumes:
      # Persistent data (SQLite database)
      - ./data:/data
      # Logs
      - ./logs:/app/logs

    environment:
      # Application
      APP_ENV: production
      LOG_LEVEL: INFO
      PORT: 8088

      # Database - Self-contained SQLite (like Sonarr/Radarr)
      DATABASE_URL: sqlite:////data/autoarr.db

      # Cache - In-memory (no external Redis required)
      REDIS_URL: memory://

      # SABnzbd Configuration
      SABNZBD_ENABLED: ${SABNZBD_ENABLED:-true}
      SABNZBD_URL: ${SABNZBD_URL}
      SABNZBD_API_KEY: ${SABNZBD_API_KEY}
      SABNZBD_TIMEOUT: 30

      # Sonarr Configuration
      SONARR_ENABLED: ${SONARR_ENABLED:-true}
      SONARR_URL: ${SONARR_URL}
      SONARR_API_KEY: ${SONARR_API_KEY}
      SONARR_TIMEOUT: 30

      # Radarr Configuration
      RADARR_ENABLED: ${RADARR_ENABLED:-true}
      RADARR_URL: ${RADARR_URL}
      RADARR_API_KEY: ${RADARR_API_KEY}
      RADARR_TIMEOUT: 30

      # Plex Configuration (optional)
      PLEX_ENABLED: ${PLEX_ENABLED:-false}
      PLEX_URL: ${PLEX_URL:-}
      PLEX_TOKEN: ${PLEX_TOKEN:-}
      PLEX_TIMEOUT: 30

      # AI Features (optional - for LLM-powered configuration audits)
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      BRAVE_API_KEY: ${BRAVE_API_KEY:-}

    # Resource limits (adjust as needed)
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 512M

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
# Optional: Connect to existing media stack network
# Uncomment if your SABnzbd/Sonarr/Radarr/Plex are on a shared Docker network
# networks:
#   default:
#     external: true
#     name: your_media_network_name
