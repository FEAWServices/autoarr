# =============================================================================
# Development Dockerfile for AutoArr
# =============================================================================
# Lightweight development image with all dependencies pre-installed.
# Source code is mounted at runtime for live reloading.
#
# Build from repo root:
#   docker build -t autoarr:dev -f docker/Dockerfile.dev .
#
# Run with docker-compose:
#   docker-compose -f docker/docker-compose.local-test.yml up
# =============================================================================

FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js and pnpm for frontend
SHELL ["/bin/bash", "-o", "pipefail", "-c"]
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y --no-install-recommends nodejs \
    && npm install -g pnpm@8.12.1 \
    && rm -rf /var/lib/apt/lists/*

# Install Playwright browser dependencies for E2E testing inside container
RUN apt-get update && npx playwright install-deps chromium && rm -rf /var/lib/apt/lists/*

# Install Poetry
RUN pip install --no-cache-dir poetry==1.7.1

# Configure poetry to not create virtual env (we're in a container)
RUN poetry config virtualenvs.create false

# Copy dependency files first for layer caching
COPY pyproject.toml poetry.lock* README.md ./

# Install Python dependencies (without dev deps for smaller image)
RUN poetry install --no-interaction --no-ansi --without dev --no-root

# Expose ports
EXPOSE 8088 3000

# Default command: run backend with multiple workers for better performance
CMD ["uvicorn", "autoarr.api.main:app", "--host", "0.0.0.0", "--port", "8088", "--workers", "4"]
