name: Native Build

on:
  # Trigger on version tags
  push:
    tags:
      - "v*"
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      version:
        description: "Version to build (e.g., 1.0.0)"
        required: false
        default: "1.0.0-dev"

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64
          - os: linux
            arch: x64
            runner: ubuntu-latest
            python: "3.11"
            artifact_ext: tar.gz

          # Windows x64
          - os: windows
            arch: x64
            runner: windows-latest
            python: "3.11"
            artifact_ext: zip

          # macOS x64 (Intel)
          - os: macos
            arch: x64
            runner: macos-13 # Intel Mac
            python: "3.11"
            artifact_ext: tar.gz

          # macOS ARM64 (Apple Silicon)
          - os: macos
            arch: arm64
            runner: macos-14 # Apple Silicon
            python: "3.11"
            artifact_ext: tar.gz

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "push" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="${{ github.event.inputs.version || '1.0.0-dev' }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
        shell: bash

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.7.1
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ matrix.arch }}-${{ matrix.python }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-${{ matrix.arch }}-${{ matrix.python }}-

      - name: Install dependencies
        run: poetry install --no-interaction --with dev

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-${{ runner.os }}-${{ hashFiles('autoarr/ui/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-${{ runner.os }}-

      - name: Install frontend dependencies
        working-directory: autoarr/ui
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        working-directory: autoarr/ui
        run: pnpm run build
        env:
          NODE_ENV: production

      - name: Install PyInstaller
        run: poetry run pip install pyinstaller

      - name: Build native executable
        run: |
          poetry run pyinstaller autoarr.spec --noconfirm
          ls -la dist/

      - name: Create archive (Linux/macOS)
        if: matrix.os != 'windows'
        run: |
          cd dist
          tar -czvf autoarr-${{ matrix.os }}-${{ matrix.arch }}-${{ steps.version.outputs.version }}.${{ matrix.artifact_ext }} autoarr/
          ls -la

      - name: Create archive (Windows)
        if: matrix.os == 'windows'
        shell: pwsh
        run: |
          cd dist
          Compress-Archive -Path autoarr -DestinationPath autoarr-${{ matrix.os }}-${{ matrix.arch }}-${{ steps.version.outputs.version }}.${{ matrix.artifact_ext }}
          Get-ChildItem

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: autoarr-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/autoarr-${{ matrix.os }}-${{ matrix.arch }}-${{ steps.version.outputs.version }}.${{ matrix.artifact_ext }}
          retention-days: 30

  # Create GitHub release if triggered by a tag
  release:
    name: Create Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts

      - name: List artifacts
        run: |
          find artifacts -type f -name "*.tar.gz" -o -name "*.zip"

      - name: Generate checksums
        run: |
          cd artifacts
          find . -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec sha256sum {} \; > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Get version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: AutoArr v${{ steps.version.outputs.version }}
          body: |
            ## AutoArr v${{ steps.version.outputs.version }}

            ### Downloads

            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | Linux | x64 | `autoarr-linux-x64-${{ steps.version.outputs.version }}.tar.gz` |
            | Windows | x64 | `autoarr-windows-x64-${{ steps.version.outputs.version }}.zip` |
            | macOS | x64 (Intel) | `autoarr-macos-x64-${{ steps.version.outputs.version }}.tar.gz` |
            | macOS | ARM64 (Apple Silicon) | `autoarr-macos-arm64-${{ steps.version.outputs.version }}.tar.gz` |

            ### Installation

            **Linux/macOS:**
            ```bash
            tar -xzf autoarr-*.tar.gz
            cd autoarr
            ./autoarr
            ```

            **Windows:**
            1. Extract the zip file
            2. Run `autoarr.exe`

            ### Checksums
            See `SHA256SUMS.txt` for file integrity verification.

          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
            artifacts/SHA256SUMS.txt
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
