name: Python CI

on:
  push:
    branches:
      - main # Production
      - develop # Staging/Daily latest
      - "feature/**" # Feature branches
      - "fix/**" # Bug fixes
    paths:
      - "autoarr/**/*.py"
      - "pyproject.toml"
      - "poetry.lock"
      - ".github/workflows/python-ci.yml"
  pull_request:
    branches:
      - main # PRs to production
      - develop # PRs to staging
    paths:
      - "autoarr/**/*.py"
      - "pyproject.toml"
      - "poetry.lock"
      - ".github/workflows/python-ci.yml"

# Cancel in-progress runs when a new workflow is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint & Type Check
    runs-on: [self-hosted, alienware]
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.7.1
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-3.11-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-3.11-

      - name: Install dependencies
        run: poetry install --no-interaction --with dev

      - name: Run Black (formatting check)
        run: poetry run black --check autoarr/

      - name: Run isort (import sorting check)
        run: poetry run isort --check-only autoarr/

      - name: Run Flake8 (linting)
        run: poetry run flake8 autoarr/

      - name: Run Pylint (additional linting)
        run: |
          poetry run pylint autoarr/api/ autoarr/shared/ \
            --max-line-length=100 \
            --disable=C0114,C0115,C0116,R0903 \
            --fail-under=8.0
        continue-on-error: true

      - name: Run MyPy (type checking)
        run: |
          poetry run mypy autoarr/api/ autoarr/shared/ \
            --config-file=pyproject.toml \
            --ignore-missing-imports \
            --show-error-codes \
            --pretty
        continue-on-error: true

  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: [self-hosted, alienware]
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.7.1
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-${{ matrix.python-version }}-

      - name: Install dependencies
        run: poetry install --no-interaction --with dev

      - name: Run unit tests
        run: |
          poetry run pytest autoarr/tests/unit/ \
            -v \
            --cov=autoarr/api \
            --cov=autoarr/shared \
            --cov=autoarr/mcp_servers \
            --cov-report=xml \
            --cov-report=term-missing:skip-covered \
            --cov-report=html \
            --cov-fail-under=70 \
            --junit-xml=test-results/junit.xml \
            --maxfail=10 \
            -ra

      - name: Run integration tests
        run: |
          poetry run pytest autoarr/tests/integration/ \
            -v \
            --junit-xml=test-results/integration-junit.xml \
            --maxfail=5 \
            -ra
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.11'
        with:
          file: ./coverage.xml
          flags: unittests
          name: autoarr-python
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-py${{ matrix.python-version }}
          path: test-results/

      - name: Upload coverage HTML
        uses: actions/upload-artifact@v4
        if: always() && matrix.python-version == '3.11'
        with:
          name: coverage-html
          path: htmlcov/

  security:
    name: Security Scan
    runs-on: [self-hosted, alienware]
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.7.1
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Install dependencies
        run: poetry install --no-interaction --with dev

      - name: Run Bandit (security scanner)
        run: |
          poetry run bandit -r autoarr/api/ autoarr/shared/ autoarr/mcp_servers/ \
            -f json -o bandit-report.json \
            -ll -i || true
          poetry run bandit -r autoarr/api/ autoarr/shared/ autoarr/mcp_servers/ \
            -f screen \
            -ll
        continue-on-error: true

      - name: Run Safety (dependency vulnerability check)
        run: |
          poetry run safety check \
            --json \
            --output safety-report.json || true
          poetry run safety check
        continue-on-error: true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  dependency-review:
    name: Dependency Review
    runs-on: [self-hosted, alienware]
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          fail-on-scopes: runtime
        continue-on-error: true
