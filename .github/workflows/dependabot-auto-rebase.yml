name: Dependabot Auto Rebase

on:
  # Run when PRs have merge conflicts
  pull_request_target:
    types: [opened, synchronize]
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to rebase"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-rebase:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Check for merge conflicts
        id: check-conflicts
        uses: actions/github-script@v8
        with:
          script: |
            let prNumber;
            if (context.eventName === 'workflow_dispatch' && context.payload.inputs.pr_number) {
              prNumber = parseInt(context.payload.inputs.pr_number);
            } else if (context.payload.pull_request) {
              prNumber = context.payload.pull_request.number;
            } else {
              console.log('No PR number found');
              return;
            }

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            console.log(`PR #${prNumber} mergeable_state: ${pr.mergeable_state}`);
            console.log(`PR #${prNumber} mergeable: ${pr.mergeable}`);

            // Check if PR has conflicts or is behind
            const needsRebase = pr.mergeable_state === 'dirty' ||
                               pr.mergeable_state === 'behind' ||
                               pr.mergeable === false;

            core.setOutput('needs_rebase', needsRebase);
            core.setOutput('pr_number', prNumber);
            core.setOutput('is_dependabot', pr.user.login === 'dependabot[bot]');

      - name: Trigger dependabot rebase
        if: steps.check-conflicts.outputs.needs_rebase == 'true' && steps.check-conflicts.outputs.is_dependabot == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = ${{ steps.check-conflicts.outputs.pr_number }};

            // Post comment to trigger dependabot rebase
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: '@dependabot rebase'
            });

            console.log(`Posted @dependabot rebase comment on PR #${prNumber}`);

  # Separate job to check all open dependabot PRs periodically
  check-all-dependabot-prs:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && !github.event.inputs.pr_number
    steps:
      - name: Find and rebase conflicting dependabot PRs
        uses: actions/github-script@v8
        with:
          script: |
            // Get all open PRs from dependabot
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const dependabotPrs = prs.filter(pr => pr.user.login === 'dependabot[bot]');
            console.log(`Found ${dependabotPrs.length} open dependabot PRs`);

            for (const pr of dependabotPrs) {
              // Get full PR details to check mergeable state
              const { data: fullPr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });

              const needsRebase = fullPr.mergeable_state === 'dirty' ||
                                 fullPr.mergeable_state === 'behind' ||
                                 fullPr.mergeable === false;

              if (needsRebase) {
                console.log(`PR #${pr.number} needs rebase (state: ${fullPr.mergeable_state})`);

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: '@dependabot rebase'
                });

                console.log(`Posted @dependabot rebase comment on PR #${pr.number}`);

                // Add small delay to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 1000));
              } else {
                console.log(`PR #${pr.number} is OK (state: ${fullPr.mergeable_state})`);
              }
            }
