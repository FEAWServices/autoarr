version: '3.8'

# AutoArr Local Development Environment
# This docker-compose file runs AutoArr backend and frontend for local development
# It connects to your EXISTING Sonarr, Radarr, SABnzbd, and Plex instances
#
# Prerequisites:
# 1. Copy .env.local to .env and configure your service URLs and API keys
# 2. Ensure your media services are accessible from this machine
# 3. Run: docker-compose -f docker-compose.dev.yml up -d

services:
  # AutoArr Backend API
  autoarr-backend:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: autoarr-backend-dev
    env_file:
      - .env
    environment:
      # Application Settings
      - APP_ENV=development
      - LOG_LEVEL=DEBUG
      - PORT=8088
      - DATABASE_URL=sqlite:////data/autoarr.db
      - REDIS_URL=memory://

      # Service URLs and API keys from .env file
      - SABNZBD_ENABLED=${SABNZBD_ENABLED:-true}
      - SABNZBD_URL=${SABNZBD_URL}
      - SABNZBD_API_KEY=${SABNZBD_API_KEY}
      - SABNZBD_TIMEOUT=30

      - SONARR_ENABLED=${SONARR_ENABLED:-true}
      - SONARR_URL=${SONARR_URL}
      - SONARR_API_KEY=${SONARR_API_KEY}
      - SONARR_TIMEOUT=30

      - RADARR_ENABLED=${RADARR_ENABLED:-true}
      - RADARR_URL=${RADARR_URL}
      - RADARR_API_KEY=${RADARR_API_KEY}
      - RADARR_TIMEOUT=30

      - PLEX_ENABLED=${PLEX_ENABLED:-false}
      - PLEX_URL=${PLEX_URL:-}
      - PLEX_TOKEN=${PLEX_TOKEN:-}
      - PLEX_TIMEOUT=30

      # AI Features (Optional)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - BRAVE_API_KEY=${BRAVE_API_KEY:-}
    volumes:
      # Mount source code for hot reload
      - ./autoarr:/app/autoarr:ro
      - ./pyproject.toml:/app/pyproject.toml:ro
      - ./poetry.lock:/app/poetry.lock:ro
      - ./README.md:/app/README.md:ro
      # Persistent data
      - ./dev-data/data:/data
      - ./dev-data/logs:/app/logs
    ports:
      - "8088:8088"
    restart: unless-stopped
    # Use host network mode to access services on localhost
    network_mode: "host"
    command: >
      sh -c "
        cd /app &&
        poetry install --with dev &&
        cd autoarr &&
        poetry run uvicorn api.main:app --host 0.0.0.0 --port 8088 --reload
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  # AutoArr Frontend UI (Optional - can also run with 'pnpm dev' locally)
  # autoarr-frontend:
  #   build:
  #     context: ./autoarr/ui
  #     dockerfile: Dockerfile.dev
  #   container_name: autoarr-frontend-dev
  #   environment:
  #     - VITE_API_URL=http://localhost:8088
  #     - VITE_WS_URL=ws://localhost:8088
  #   volumes:
  #     - ./autoarr/ui/src:/app/src
  #     - ./autoarr/ui/public:/app/public
  #     - /app/node_modules
  #   ports:
  #     - "3000:3000"
  #   network_mode: "host"
  #   depends_on:
  #     - autoarr-backend
  #   command: pnpm dev --host 0.0.0.0 --port 3000
