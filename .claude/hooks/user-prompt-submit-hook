#!/bin/bash
# Claude Code Hook: Auto-cleanup before processing user prompts
# This runs BEFORE Claude processes each user message

# Exit codes:
# 0 = Continue normally
# Non-zero = Block with error message

# ==============================================================================
# FIX: Unset empty GIT_AUTHOR/COMMITTER env vars
# Claude Code may set these as empty strings, which override git config
# and cause "fatal: empty ident name" errors.
# ==============================================================================
for var in GIT_AUTHOR_NAME GIT_AUTHOR_EMAIL GIT_COMMITTER_NAME GIT_COMMITTER_EMAIL; do
  val=$(printenv "$var" 2>/dev/null || true)
  if [ -z "$val" ] && printenv "$var" >/dev/null 2>&1; then
    unset "$var"
  fi
done

# ==============================================================================
# Check Docker container status for autoarr-local
# ==============================================================================
if command -v docker &> /dev/null; then
  CONTAINER_STATUS=$(DOCKER_HOST=unix:///var/run/docker.sock docker ps --filter "name=autoarr-local" --format "{{.Status}}" 2>/dev/null || echo "")
  if [[ -z "$CONTAINER_STATUS" ]]; then
    echo "Note: autoarr-local container is not running"
  fi
fi

# ==============================================================================
# Check for uncommitted changes warning
# ==============================================================================
if command -v git &> /dev/null; then
  UNCOMMITTED=$(git status --porcelain 2>/dev/null | wc -l)
  if [[ $UNCOMMITTED -gt 10 ]]; then
    echo "Note: $UNCOMMITTED uncommitted changes in working directory"
  fi
fi

# ==============================================================================
# Memory cleanup for devcontainer environments
# ==============================================================================
if [[ -f "/proc/meminfo" ]]; then
  MEM_PERCENT=$(free 2>/dev/null | grep Mem | awk '{printf "%.0f", $3/$2 * 100.0}' || echo "0")

  # If memory usage is above 75%, warn
  if [[ $MEM_PERCENT -gt 75 ]]; then
    echo "Memory usage high ($MEM_PERCENT%)"
  fi
fi

# Always continue - don't block Claude
exit 0
